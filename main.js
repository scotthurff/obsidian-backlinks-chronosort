var u=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var k=(g,l)=>{for(var e in l)u(g,e,{get:l[e],enumerable:!0})},y=(g,l,e,t)=>{if(l&&typeof l=="object"||typeof l=="function")for(let o of b(l))!S.call(g,o)&&o!==e&&u(g,o,{get:()=>l[o],enumerable:!(t=p(l,o))||t.enumerable});return g};var C=g=>y(u({},"__esModule",{value:!0}),g);var D={};k(D,{default:()=>h});module.exports=C(D);var d=require("obsidian"),M={enableInDocument:!0,enableSidebar:!0,sortDescending:!0,debugMode:!1},h=class extends d.Plugin{constructor(){super(...arguments);this.pendingSort=null;this.styleEl=null}async onload(){await this.loadSettings(),console.log("[ChronoSort] Plugin loaded"),this.styleEl=document.createElement("style"),this.styleEl.id="chronosort-styles",this.styleEl.textContent="",document.head.appendChild(this.styleEl),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.settings.debugMode&&console.log("[ChronoSort] active-leaf-change event"),this.scheduleSortBacklinks()})),this.registerEvent(this.app.workspace.on("layout-change",()=>{this.settings.debugMode&&console.log("[ChronoSort] layout-change event"),this.scheduleSortBacklinks()})),this.app.workspace.onLayoutReady(()=>{this.settings.debugMode&&console.log("[ChronoSort] Layout ready"),this.scheduleSortBacklinks()}),this.addCommand({id:"sort-backlinks-now",name:"Sort backlinks chronologically now",callback:()=>{this.sortAllBacklinks()}}),this.addSettingTab(new m(this.app,this))}onunload(){console.log("[ChronoSort] Plugin unloaded"),this.pendingSort&&clearTimeout(this.pendingSort),this.styleEl&&this.styleEl.remove()}async loadSettings(){this.settings=Object.assign({},M,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}scheduleSortBacklinks(){this.pendingSort&&clearTimeout(this.pendingSort),this.pendingSort=setTimeout(()=>{this.sortAllBacklinks(),this.pendingSort=null},500)}sortAllBacklinks(){this.settings.debugMode&&console.log("[ChronoSort] Running sortAllBacklinks"),this.settings.enableInDocument&&(this.sortInDocumentBacklinks(),this.sortDailyNotesEditorBacklinks()),this.settings.enableSidebar&&this.sortSidebarBacklinks()}sortInDocumentBacklinks(){let e=this.app.workspace.getActiveViewOfType(d.MarkdownView);if(!e){this.settings.debugMode&&console.log("[ChronoSort] No active markdown view");return}let t=[".backlink-pane .search-result-container",".backlink-pane",".embedded-backlinks .search-result-container",".embedded-backlinks"],o=null;for(let n of t)if(o=e.containerEl.querySelector(n),o){this.settings.debugMode&&console.log(`[ChronoSort] Found in-document backlinks with selector: ${n}`);break}if(!o){this.settings.debugMode&&console.log("[ChronoSort] No in-document backlinks container found");return}this.applySortOrder(o,"in-document")}sortSidebarBacklinks(){let e=['div[data-type="backlink"] .search-result-container','.workspace-leaf-content[data-type="backlink"] .search-result-container'],t=null;for(let o of e)if(t=document.querySelector(o),t){this.settings.debugMode&&console.log(`[ChronoSort] Found sidebar backlinks with selector: ${o}`);break}if(!t){this.settings.debugMode&&console.log("[ChronoSort] No sidebar backlinks pane found");return}this.applySortOrder(t,"sidebar")}sortDailyNotesEditorBacklinks(){let e=document.querySelectorAll(".daily-note-editor");if(e.length===0){this.settings.debugMode&&console.log("[ChronoSort] No Daily Notes Editor views found");return}this.settings.debugMode&&console.log(`[ChronoSort] Found ${e.length} Daily Notes Editor view(s)`),e.forEach((t,o)=>{let n=t.querySelectorAll(".embedded-backlinks .search-result-container");if(n.length===0){let a=t.querySelectorAll(".embedded-backlinks");this.settings.debugMode&&console.log(`[ChronoSort] Daily Notes Editor view ${o}: ${a.length} embedded-backlinks found (fallback)`),a.forEach((r,s)=>{this.applySortOrder(r,`daily-notes-editor-${o}-${s}`)})}else this.settings.debugMode&&console.log(`[ChronoSort] Daily Notes Editor view ${o}: ${n.length} backlinks containers found`),n.forEach((a,r)=>{this.applySortOrder(a,`daily-notes-editor-${o}-${r}`)})})}applySortOrder(e,t){let o=[":scope > .tree-item.search-result",":scope > .search-result",".tree-item.search-result",".search-result"],n=null,a="";for(let s of o){let i=e.querySelectorAll(s);if(i.length>0){n=i,a=s;break}}if(!n||n.length===0){this.settings.debugMode&&(console.log(`[ChronoSort] No backlink items found in ${t}`),console.log("[ChronoSort] Container children:",Array.from(e.children).map(s=>{var i,c;return{tag:s.tagName,classes:s.className,firstChildText:(c=(i=s.querySelector(".tree-item-inner"))==null?void 0:i.textContent)==null?void 0:c.slice(0,50)}})));return}this.settings.debugMode&&console.log(`[ChronoSort] Found ${n.length} items in ${t} using selector: ${a}`),this.settings.debugMode&&console.log(`[ChronoSort] Sorting ${n.length} backlinks in ${t}`);let r=[];n.forEach(s=>{let i=this.extractFilename(s),c=this.getTimestamp(i);r.push({element:s,timestamp:c,filename:i})}),r.sort((s,i)=>{let c=s.timestamp-i.timestamp;return this.settings.sortDescending?-c:c}),this.settings.debugMode&&console.log("[ChronoSort] Sorted order:",r.slice(0,10).map(s=>`${s.filename} (${new Date(s.timestamp).toISOString().split("T")[0]})`)),r.forEach(s=>{e.appendChild(s.element)}),this.settings.debugMode&&console.log(`[ChronoSort] Sorted ${r.length} items in ${t}`)}extractFilename(e){var a,r,s;let t=e.querySelector(":scope > .tree-item-self .tree-item-inner");if(t){let i=((a=t.textContent)==null?void 0:a.trim())||"";if(this.settings.debugMode&&i&&console.log(`[ChronoSort] Extracted from tree-item-self: "${i}"`),i)return i}let o=e.querySelector(".search-result-file-title");if(o){let i=((r=o.textContent)==null?void 0:r.trim())||"";if(this.settings.debugMode&&i&&console.log(`[ChronoSort] Extracted from file-title: "${i}"`),i)return i}let n=e.querySelectorAll(".tree-item-inner");for(let i of Array.from(n)){if(i.closest(".search-result-file-matches"))continue;let c=((s=i.textContent)==null?void 0:s.trim())||"";if(c)return this.settings.debugMode&&console.log(`[ChronoSort] Extracted from filtered tree-item-inner: "${c}"`),c}return this.settings.debugMode&&console.log("[ChronoSort] Could not extract filename from item"),""}getTimestamp(e){let t=this.parseRoamDate(e);if(t!==null)return this.settings.debugMode&&console.log(`[ChronoSort] Parsed Roam date for "${e}": ${new Date(t).toISOString()}`),t;let o=this.parseISODate(e);if(o!==null)return this.settings.debugMode&&console.log(`[ChronoSort] Parsed ISO date for "${e}": ${new Date(o).toISOString()}`),o;let n=this.app.vault.getAbstractFileByPath(e+".md")||this.app.vault.getAbstractFileByPath(e);if(this.settings.debugMode&&console.log(`[ChronoSort] File lookup for "${e}":`,{foundFile:!!n,isFile:n instanceof d.TFile,filePath:n==null?void 0:n.path}),n&&n instanceof d.TFile){let s=this.getFrontmatterDate(n);return s!==null?(this.settings.debugMode&&console.log(`[ChronoSort] Using frontmatter 'edited' for "${e}": ${new Date(s).toISOString()}`),s):(this.settings.debugMode&&console.log(`[ChronoSort] Using mtime for "${e}": ${new Date(n.stat.mtime).toISOString()}`),n.stat.mtime)}let a=`Daily Notes/${e}.md`,r=this.app.vault.getAbstractFileByPath(a);return r&&r instanceof d.TFile?(this.settings.debugMode&&console.log(`[ChronoSort] Using Daily Notes mtime for "${e}": ${new Date(r.stat.mtime).toISOString()}`),r.stat.mtime):(this.settings.debugMode&&console.log(`[ChronoSort] No timestamp found for "${e}", returning 0`),0)}getFrontmatterDate(e){var c,f;let t=this.app.metadataCache.getFileCache(e);if(this.settings.debugMode&&console.log(`[ChronoSort] getFrontmatterDate for "${e.path}":`,{hasCache:!!t,hasFrontmatter:!!(t!=null&&t.frontmatter),frontmatterKeys:t!=null&&t.frontmatter?Object.keys(t.frontmatter):[],editedValue:(c=t==null?void 0:t.frontmatter)==null?void 0:c.edited,createdValue:(f=t==null?void 0:t.frontmatter)==null?void 0:f.created}),!(t!=null&&t.frontmatter))return null;let o=t.frontmatter.edited||t.frontmatter.created;if(!o)return null;let n=String(o).match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!n)return this.settings.debugMode&&console.log(`[ChronoSort] Date format mismatch for "${e.path}": "${o}"`),null;let[,a,r,s]=n;return new Date(parseInt(a),parseInt(r)-1,parseInt(s)).getTime()}parseRoamDate(e){let t={January:0,February:1,March:2,April:3,May:4,June:5,July:6,August:7,September:8,October:9,November:10,December:11},o=e.match(/^(\w+)\s+(\d+)(?:st|nd|rd|th),\s+(\d{4})$/);if(!o){let c=e.match(/\[\[(January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d+)(?:st|nd|rd|th),\s+(\d{4})\]\]/);c&&(o=c)}if(!o)return this.settings.debugMode&&e.match(/january|february|march|april|may|june|july|august|september|october|november|december/i)&&console.log(`[ChronoSort] Roam date regex FAILED for "${e}" (looks like a date but didn't match)`),null;let[,n,a,r]=o,s=t[n];if(s===void 0)return null;let i=new Date(parseInt(r),s,parseInt(a));return i.getFullYear()!==parseInt(r)||i.getMonth()!==s||i.getDate()!==parseInt(a)?null:i.getTime()}parseISODate(e){let t=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!t)return null;let[,o,n,a]=t,r=new Date(parseInt(o),parseInt(n)-1,parseInt(a));return r.getFullYear()!==parseInt(o)||r.getMonth()!==parseInt(n)-1||r.getDate()!==parseInt(a)?null:r.getTime()}},m=class extends d.PluginSettingTab{constructor(l,e){super(l,e),this.plugin=e}display(){let{containerEl:l}=this;l.empty(),l.createEl("h2",{text:"Backlinks Chronological Sort"}),new d.Setting(l).setName("Enable for in-document backlinks").setDesc("Sort backlinks shown at the bottom of notes").addToggle(e=>e.setValue(this.plugin.settings.enableInDocument).onChange(async t=>{this.plugin.settings.enableInDocument=t,await this.plugin.saveSettings()})),new d.Setting(l).setName("Enable for sidebar backlinks").setDesc("Sort backlinks shown in the sidebar pane").addToggle(e=>e.setValue(this.plugin.settings.enableSidebar).onChange(async t=>{this.plugin.settings.enableSidebar=t,await this.plugin.saveSettings()})),new d.Setting(l).setName("Sort descending (newest first)").setDesc("When enabled, most recent dates appear at the top").addToggle(e=>e.setValue(this.plugin.settings.sortDescending).onChange(async t=>{this.plugin.settings.sortDescending=t,await this.plugin.saveSettings()})),new d.Setting(l).setName("Debug mode").setDesc("Log sorting information to console").addToggle(e=>e.setValue(this.plugin.settings.debugMode).onChange(async t=>{this.plugin.settings.debugMode=t,await this.plugin.saveSettings()}))}};
