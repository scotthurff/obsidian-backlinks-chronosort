var h=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var k=(d,r)=>{for(var e in r)h(d,e,{get:r[e],enumerable:!0})},y=(d,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of f(r))!S.call(d,n)&&n!==e&&h(d,n,{get:()=>r[n],enumerable:!(t=b(r,n))||t.enumerable});return d};var C=d=>y(h({},"__esModule",{value:!0}),d);var D={};k(D,{default:()=>u});module.exports=C(D);var c=require("obsidian"),M={enableInDocument:!0,enableSidebar:!0,sortDescending:!0,debugMode:!1},u=class extends c.Plugin{constructor(){super(...arguments);this.pendingSort=null;this.styleEl=null}async onload(){await this.loadSettings(),console.log("[ChronoSort] Plugin loaded"),this.styleEl=document.createElement("style"),this.styleEl.id="chronosort-styles",this.styleEl.textContent="",document.head.appendChild(this.styleEl),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.settings.debugMode&&console.log("[ChronoSort] active-leaf-change event"),this.scheduleSortBacklinks()})),this.registerEvent(this.app.workspace.on("layout-change",()=>{this.settings.debugMode&&console.log("[ChronoSort] layout-change event"),this.scheduleSortBacklinks()})),this.app.workspace.onLayoutReady(()=>{this.settings.debugMode&&console.log("[ChronoSort] Layout ready"),this.scheduleSortBacklinks()}),this.addCommand({id:"sort-backlinks-now",name:"Sort backlinks chronologically now",callback:()=>{this.sortAllBacklinks()}}),this.addSettingTab(new m(this.app,this))}onunload(){console.log("[ChronoSort] Plugin unloaded"),this.pendingSort&&clearTimeout(this.pendingSort),this.styleEl&&this.styleEl.remove()}async loadSettings(){this.settings=Object.assign({},M,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}scheduleSortBacklinks(){this.pendingSort&&clearTimeout(this.pendingSort),this.pendingSort=setTimeout(()=>{this.sortAllBacklinks(),this.pendingSort=null},500)}sortAllBacklinks(){this.settings.debugMode&&console.log("[ChronoSort] Running sortAllBacklinks"),this.settings.enableInDocument&&(this.sortInDocumentBacklinks(),this.sortDailyNotesEditorBacklinks()),this.settings.enableSidebar&&this.sortSidebarBacklinks()}sortInDocumentBacklinks(){let e=this.app.workspace.getActiveViewOfType(c.MarkdownView);if(!e){this.settings.debugMode&&console.log("[ChronoSort] No active markdown view");return}let t=[".backlink-pane .search-result-container",".backlink-pane",".embedded-backlinks .search-result-container",".embedded-backlinks"],n=null;for(let o of t)if(n=e.containerEl.querySelector(o),n){this.settings.debugMode&&console.log(`[ChronoSort] Found in-document backlinks with selector: ${o}`);break}if(!n){this.settings.debugMode&&console.log("[ChronoSort] No in-document backlinks container found");return}this.applySortOrder(n,"in-document")}sortSidebarBacklinks(){let e=['div[data-type="backlink"] .search-result-container','.workspace-leaf-content[data-type="backlink"] .search-result-container'],t=null;for(let n of e)if(t=document.querySelector(n),t){this.settings.debugMode&&console.log(`[ChronoSort] Found sidebar backlinks with selector: ${n}`);break}if(!t){this.settings.debugMode&&console.log("[ChronoSort] No sidebar backlinks pane found");return}this.applySortOrder(t,"sidebar")}sortDailyNotesEditorBacklinks(){let e=document.querySelectorAll(".daily-note-editor");if(e.length===0){this.settings.debugMode&&console.log("[ChronoSort] No Daily Notes Editor views found");return}this.settings.debugMode&&console.log(`[ChronoSort] Found ${e.length} Daily Notes Editor view(s)`),e.forEach((t,n)=>{let o=t.querySelectorAll(".embedded-backlinks .search-result-container");if(o.length===0){let s=t.querySelectorAll(".embedded-backlinks");this.settings.debugMode&&console.log(`[ChronoSort] Daily Notes Editor view ${n}: ${s.length} embedded-backlinks found (fallback)`),s.forEach((i,a)=>{this.applySortOrder(i,`daily-notes-editor-${n}-${a}`)})}else this.settings.debugMode&&console.log(`[ChronoSort] Daily Notes Editor view ${n}: ${o.length} backlinks containers found`),o.forEach((s,i)=>{this.applySortOrder(s,`daily-notes-editor-${n}-${i}`)})})}applySortOrder(e,t){let n=e.querySelectorAll(":scope > .tree-item.search-result");if(n.length===0){this.settings.debugMode&&console.log(`[ChronoSort] No backlink items found in ${t}`);return}this.settings.debugMode&&console.log(`[ChronoSort] Sorting ${n.length} backlinks in ${t} (one-time)`);let o=[];n.forEach(s=>{let i=this.extractFilename(s),a=this.getTimestamp(i);o.push({element:s,timestamp:a,filename:i})}),o.sort((s,i)=>{let a=s.timestamp-i.timestamp;return this.settings.sortDescending?-a:a}),this.settings.debugMode&&console.log("[ChronoSort] Sorted order:",o.slice(0,10).map(s=>`${s.filename} (${new Date(s.timestamp).toISOString().split("T")[0]})`)),o.forEach(s=>{e.appendChild(s.element)}),this.settings.debugMode&&console.log(`[ChronoSort] Sorted ${o.length} items in ${t}`)}extractFilename(e){var s,i,a;let t=e.querySelector(":scope > .tree-item-self .tree-item-inner");if(t){let l=((s=t.textContent)==null?void 0:s.trim())||"";if(this.settings.debugMode&&l&&console.log(`[ChronoSort] Extracted from tree-item-self: "${l}"`),l)return l}let n=e.querySelector(".search-result-file-title");if(n){let l=((i=n.textContent)==null?void 0:i.trim())||"";if(this.settings.debugMode&&l&&console.log(`[ChronoSort] Extracted from file-title: "${l}"`),l)return l}let o=e.querySelectorAll(".tree-item-inner");for(let l of Array.from(o)){if(l.closest(".search-result-file-matches"))continue;let g=((a=l.textContent)==null?void 0:a.trim())||"";if(g)return this.settings.debugMode&&console.log(`[ChronoSort] Extracted from filtered tree-item-inner: "${g}"`),g}return this.settings.debugMode&&console.log("[ChronoSort] Could not extract filename from item"),""}getTimestamp(e){let t=this.parseRoamDate(e);if(t!==null)return this.settings.debugMode&&console.log(`[ChronoSort] Parsed Roam date for "${e}": ${new Date(t).toISOString()}`),t;let n=this.parseISODate(e);if(n!==null)return this.settings.debugMode&&console.log(`[ChronoSort] Parsed ISO date for "${e}": ${new Date(n).toISOString()}`),n;let o=this.app.vault.getAbstractFileByPath(e+".md")||this.app.vault.getAbstractFileByPath(e);if(this.settings.debugMode&&console.log(`[ChronoSort] File lookup for "${e}":`,{foundFile:!!o,isFile:o instanceof c.TFile,filePath:o==null?void 0:o.path}),o&&o instanceof c.TFile){let a=this.getFrontmatterDate(o);return a!==null?(this.settings.debugMode&&console.log(`[ChronoSort] Using frontmatter 'edited' for "${e}": ${new Date(a).toISOString()}`),a):(this.settings.debugMode&&console.log(`[ChronoSort] Using mtime for "${e}": ${new Date(o.stat.mtime).toISOString()}`),o.stat.mtime)}let s=`Daily Notes/${e}.md`,i=this.app.vault.getAbstractFileByPath(s);return i&&i instanceof c.TFile?(this.settings.debugMode&&console.log(`[ChronoSort] Using Daily Notes mtime for "${e}": ${new Date(i.stat.mtime).toISOString()}`),i.stat.mtime):(this.settings.debugMode&&console.log(`[ChronoSort] No timestamp found for "${e}", returning 0`),0)}getFrontmatterDate(e){var g,p;let t=this.app.metadataCache.getFileCache(e);if(this.settings.debugMode&&console.log(`[ChronoSort] getFrontmatterDate for "${e.path}":`,{hasCache:!!t,hasFrontmatter:!!(t!=null&&t.frontmatter),frontmatterKeys:t!=null&&t.frontmatter?Object.keys(t.frontmatter):[],editedValue:(g=t==null?void 0:t.frontmatter)==null?void 0:g.edited,createdValue:(p=t==null?void 0:t.frontmatter)==null?void 0:p.created}),!(t!=null&&t.frontmatter))return null;let n=t.frontmatter.edited||t.frontmatter.created;if(!n)return null;let o=String(n).match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!o)return this.settings.debugMode&&console.log(`[ChronoSort] Date format mismatch for "${e.path}": "${n}"`),null;let[,s,i,a]=o;return new Date(parseInt(s),parseInt(i)-1,parseInt(a)).getTime()}parseRoamDate(e){let t={January:0,February:1,March:2,April:3,May:4,June:5,July:6,August:7,September:8,October:9,November:10,December:11},n=e.match(/^(\w+)\s+(\d+)(?:st|nd|rd|th),\s+(\d{4})$/);if(!n){let g=e.match(/\[\[(January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d+)(?:st|nd|rd|th),\s+(\d{4})\]\]/);g&&(n=g)}if(!n)return this.settings.debugMode&&e.match(/january|february|march|april|may|june|july|august|september|october|november|december/i)&&console.log(`[ChronoSort] Roam date regex FAILED for "${e}" (looks like a date but didn't match)`),null;let[,o,s,i]=n,a=t[o];if(a===void 0)return null;let l=new Date(parseInt(i),a,parseInt(s));return l.getFullYear()!==parseInt(i)||l.getMonth()!==a||l.getDate()!==parseInt(s)?null:l.getTime()}parseISODate(e){let t=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!t)return null;let[,n,o,s]=t,i=new Date(parseInt(n),parseInt(o)-1,parseInt(s));return i.getFullYear()!==parseInt(n)||i.getMonth()!==parseInt(o)-1||i.getDate()!==parseInt(s)?null:i.getTime()}},m=class extends c.PluginSettingTab{constructor(r,e){super(r,e),this.plugin=e}display(){let{containerEl:r}=this;r.empty(),r.createEl("h2",{text:"Backlinks Chronological Sort"}),new c.Setting(r).setName("Enable for in-document backlinks").setDesc("Sort backlinks shown at the bottom of notes").addToggle(e=>e.setValue(this.plugin.settings.enableInDocument).onChange(async t=>{this.plugin.settings.enableInDocument=t,await this.plugin.saveSettings()})),new c.Setting(r).setName("Enable for sidebar backlinks").setDesc("Sort backlinks shown in the sidebar pane").addToggle(e=>e.setValue(this.plugin.settings.enableSidebar).onChange(async t=>{this.plugin.settings.enableSidebar=t,await this.plugin.saveSettings()})),new c.Setting(r).setName("Sort descending (newest first)").setDesc("When enabled, most recent dates appear at the top").addToggle(e=>e.setValue(this.plugin.settings.sortDescending).onChange(async t=>{this.plugin.settings.sortDescending=t,await this.plugin.saveSettings()})),new c.Setting(r).setName("Debug mode").setDesc("Log sorting information to console").addToggle(e=>e.setValue(this.plugin.settings.debugMode).onChange(async t=>{this.plugin.settings.debugMode=t,await this.plugin.saveSettings()}))}};
