var u=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var k=(g,l)=>{for(var e in l)u(g,e,{get:l[e],enumerable:!0})},y=(g,l,e,t)=>{if(l&&typeof l=="object"||typeof l=="function")for(let n of f(l))!S.call(g,n)&&n!==e&&u(g,n,{get:()=>l[n],enumerable:!(t=b(l,n))||t.enumerable});return g};var C=g=>y(u({},"__esModule",{value:!0}),g);var D={};k(D,{default:()=>h});module.exports=C(D);var c=require("obsidian"),M={enableInDocument:!0,enableSidebar:!0,sortDescending:!0,debugMode:!1},h=class extends c.Plugin{constructor(){super(...arguments);this.pendingSort=null;this.styleEl=null}async onload(){await this.loadSettings(),console.log("[ChronoSort] Plugin loaded"),this.styleEl=document.createElement("style"),this.styleEl.id="chronosort-styles",this.styleEl.textContent="",document.head.appendChild(this.styleEl),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.settings.debugMode&&console.log("[ChronoSort] active-leaf-change event"),this.scheduleSortBacklinks()})),this.registerEvent(this.app.workspace.on("layout-change",()=>{this.settings.debugMode&&console.log("[ChronoSort] layout-change event"),this.scheduleSortBacklinks()})),this.app.workspace.onLayoutReady(()=>{this.settings.debugMode&&console.log("[ChronoSort] Layout ready"),this.scheduleSortBacklinks()}),this.addCommand({id:"sort-backlinks-now",name:"Sort backlinks chronologically now",callback:()=>{this.sortAllBacklinks()}}),this.addSettingTab(new m(this.app,this))}onunload(){console.log("[ChronoSort] Plugin unloaded"),this.pendingSort&&clearTimeout(this.pendingSort),this.styleEl&&this.styleEl.remove()}async loadSettings(){this.settings=Object.assign({},M,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}scheduleSortBacklinks(){this.pendingSort&&clearTimeout(this.pendingSort),this.pendingSort=setTimeout(()=>{this.sortAllBacklinks(),this.pendingSort=null},500)}sortAllBacklinks(){this.settings.debugMode&&console.log("[ChronoSort] Running sortAllBacklinks"),this.settings.enableInDocument&&(this.sortInDocumentBacklinks(),this.sortDailyNotesEditorBacklinks()),this.settings.enableSidebar&&this.sortSidebarBacklinks()}sortInDocumentBacklinks(){let e=this.app.workspace.getActiveViewOfType(c.MarkdownView);if(!e){this.settings.debugMode&&console.log("[ChronoSort] No active markdown view");return}let t=[".backlink-pane .search-result-container",".backlink-pane",".embedded-backlinks .search-result-container",".embedded-backlinks"],n=null;for(let o of t)if(n=e.containerEl.querySelector(o),n){this.settings.debugMode&&console.log(`[ChronoSort] Found in-document backlinks with selector: ${o}`);break}if(!n){this.settings.debugMode&&console.log("[ChronoSort] No in-document backlinks container found");return}this.applySortOrder(n,"in-document")}sortSidebarBacklinks(){let e=['div[data-type="backlink"] .search-result-container','.workspace-leaf-content[data-type="backlink"] .search-result-container'],t=null;for(let n of e)if(t=document.querySelector(n),t){this.settings.debugMode&&console.log(`[ChronoSort] Found sidebar backlinks with selector: ${n}`);break}if(!t){this.settings.debugMode&&console.log("[ChronoSort] No sidebar backlinks pane found");return}this.applySortOrder(t,"sidebar")}sortDailyNotesEditorBacklinks(){let e=document.querySelectorAll(".daily-note-editor");if(e.length===0){this.settings.debugMode&&console.log("[ChronoSort] No Daily Notes Editor views found");return}this.settings.debugMode&&console.log(`[ChronoSort] Found ${e.length} Daily Notes Editor view(s)`),e.forEach((t,n)=>{let o=t.querySelectorAll(".embedded-backlinks .search-result-container");if(o.length===0){let a=t.querySelectorAll(".embedded-backlinks");this.settings.debugMode&&console.log(`[ChronoSort] Daily Notes Editor view ${n}: ${a.length} embedded-backlinks found (fallback)`),a.forEach((s,i)=>{this.applySortOrder(s,`daily-notes-editor-${n}-${i}`)})}else this.settings.debugMode&&console.log(`[ChronoSort] Daily Notes Editor view ${n}: ${o.length} backlinks containers found`),o.forEach((a,s)=>{this.applySortOrder(a,`daily-notes-editor-${n}-${s}`)})})}applySortOrder(e,t){let n=e,o=e.querySelector(":scope > .search-results-children");o&&(n=o);let a=n.querySelectorAll(":scope > .tree-item.search-result");if(a.length===0){this.settings.debugMode&&console.log(`[ChronoSort] No backlink items found in ${t}`);return}this.settings.debugMode&&console.log(`[ChronoSort] Found ${a.length} items in ${t}`),this.settings.debugMode&&console.log(`[ChronoSort] Sorting ${a.length} backlinks in ${t}`);let s=[];a.forEach(i=>{let r=this.extractFilename(i),d=this.getTimestamp(r);s.push({element:i,timestamp:d,filename:r})}),s.sort((i,r)=>{let d=i.timestamp-r.timestamp;return this.settings.sortDescending?-d:d}),this.settings.debugMode&&console.log("[ChronoSort] Sorted order:",s.slice(0,10).map(i=>`${i.filename} (${new Date(i.timestamp).toISOString().split("T")[0]})`)),s.forEach(i=>{n.appendChild(i.element)}),this.settings.debugMode&&console.log(`[ChronoSort] Sorted ${s.length} items in ${t}`)}extractFilename(e){var a,s,i;let t=e.querySelector(":scope > .tree-item-self .tree-item-inner");if(t){let r=((a=t.textContent)==null?void 0:a.trim())||"";if(this.settings.debugMode&&r&&console.log(`[ChronoSort] Extracted from tree-item-self: "${r}"`),r)return r}let n=e.querySelector(".search-result-file-title");if(n){let r=((s=n.textContent)==null?void 0:s.trim())||"";if(this.settings.debugMode&&r&&console.log(`[ChronoSort] Extracted from file-title: "${r}"`),r)return r}let o=e.querySelectorAll(".tree-item-inner");for(let r of Array.from(o)){if(r.closest(".search-result-file-matches"))continue;let d=((i=r.textContent)==null?void 0:i.trim())||"";if(d)return this.settings.debugMode&&console.log(`[ChronoSort] Extracted from filtered tree-item-inner: "${d}"`),d}return this.settings.debugMode&&console.log("[ChronoSort] Could not extract filename from item"),""}getTimestamp(e){let t=this.parseRoamDate(e);if(t!==null)return this.settings.debugMode&&console.log(`[ChronoSort] Parsed Roam date for "${e}": ${new Date(t).toISOString()}`),t;let n=this.parseISODate(e);if(n!==null)return this.settings.debugMode&&console.log(`[ChronoSort] Parsed ISO date for "${e}": ${new Date(n).toISOString()}`),n;let o=this.app.vault.getAbstractFileByPath(e+".md")||this.app.vault.getAbstractFileByPath(e);if(this.settings.debugMode&&console.log(`[ChronoSort] File lookup for "${e}":`,{foundFile:!!o,isFile:o instanceof c.TFile,filePath:o==null?void 0:o.path}),o&&o instanceof c.TFile){let i=this.getFrontmatterDate(o);return i!==null?(this.settings.debugMode&&console.log(`[ChronoSort] Using frontmatter 'edited' for "${e}": ${new Date(i).toISOString()}`),i):(this.settings.debugMode&&console.log(`[ChronoSort] Using mtime for "${e}": ${new Date(o.stat.mtime).toISOString()}`),o.stat.mtime)}let a=`Daily Notes/${e}.md`,s=this.app.vault.getAbstractFileByPath(a);return s&&s instanceof c.TFile?(this.settings.debugMode&&console.log(`[ChronoSort] Using Daily Notes mtime for "${e}": ${new Date(s.stat.mtime).toISOString()}`),s.stat.mtime):(this.settings.debugMode&&console.log(`[ChronoSort] No timestamp found for "${e}", returning 0`),0)}getFrontmatterDate(e){var d,p;let t=this.app.metadataCache.getFileCache(e);if(this.settings.debugMode&&console.log(`[ChronoSort] getFrontmatterDate for "${e.path}":`,{hasCache:!!t,hasFrontmatter:!!(t!=null&&t.frontmatter),frontmatterKeys:t!=null&&t.frontmatter?Object.keys(t.frontmatter):[],editedValue:(d=t==null?void 0:t.frontmatter)==null?void 0:d.edited,createdValue:(p=t==null?void 0:t.frontmatter)==null?void 0:p.created}),!(t!=null&&t.frontmatter))return null;let n=t.frontmatter.edited||t.frontmatter.created;if(!n)return null;let o=String(n).match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!o)return this.settings.debugMode&&console.log(`[ChronoSort] Date format mismatch for "${e.path}": "${n}"`),null;let[,a,s,i]=o;return new Date(parseInt(a),parseInt(s)-1,parseInt(i)).getTime()}parseRoamDate(e){let t={January:0,February:1,March:2,April:3,May:4,June:5,July:6,August:7,September:8,October:9,November:10,December:11},n=e.match(/^(\w+)\s+(\d+)(?:st|nd|rd|th),\s+(\d{4})$/);if(!n){let d=e.match(/\[\[(January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d+)(?:st|nd|rd|th),\s+(\d{4})\]\]/);d&&(n=d)}if(!n)return this.settings.debugMode&&e.match(/january|february|march|april|may|june|july|august|september|october|november|december/i)&&console.log(`[ChronoSort] Roam date regex FAILED for "${e}" (looks like a date but didn't match)`),null;let[,o,a,s]=n,i=t[o];if(i===void 0)return null;let r=new Date(parseInt(s),i,parseInt(a));return r.getFullYear()!==parseInt(s)||r.getMonth()!==i||r.getDate()!==parseInt(a)?null:r.getTime()}parseISODate(e){let t=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!t)return null;let[,n,o,a]=t,s=new Date(parseInt(n),parseInt(o)-1,parseInt(a));return s.getFullYear()!==parseInt(n)||s.getMonth()!==parseInt(o)-1||s.getDate()!==parseInt(a)?null:s.getTime()}},m=class extends c.PluginSettingTab{constructor(l,e){super(l,e),this.plugin=e}display(){let{containerEl:l}=this;l.empty(),l.createEl("h2",{text:"Backlinks Chronological Sort"}),new c.Setting(l).setName("Enable for in-document backlinks").setDesc("Sort backlinks shown at the bottom of notes").addToggle(e=>e.setValue(this.plugin.settings.enableInDocument).onChange(async t=>{this.plugin.settings.enableInDocument=t,await this.plugin.saveSettings()})),new c.Setting(l).setName("Enable for sidebar backlinks").setDesc("Sort backlinks shown in the sidebar pane").addToggle(e=>e.setValue(this.plugin.settings.enableSidebar).onChange(async t=>{this.plugin.settings.enableSidebar=t,await this.plugin.saveSettings()})),new c.Setting(l).setName("Sort descending (newest first)").setDesc("When enabled, most recent dates appear at the top").addToggle(e=>e.setValue(this.plugin.settings.sortDescending).onChange(async t=>{this.plugin.settings.sortDescending=t,await this.plugin.saveSettings()})),new c.Setting(l).setName("Debug mode").setDesc("Log sorting information to console").addToggle(e=>e.setValue(this.plugin.settings.debugMode).onChange(async t=>{this.plugin.settings.debugMode=t,await this.plugin.saveSettings()}))}};
