var h=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var k=(c,i)=>{for(var t in i)h(c,t,{get:i[t],enumerable:!0})},y=(c,i,t,e)=>{if(i&&typeof i=="object"||typeof i=="function")for(let o of f(i))!S.call(c,o)&&o!==t&&h(c,o,{get:()=>i[o],enumerable:!(e=p(i,o))||e.enumerable});return c};var C=c=>y(h({},"__esModule",{value:!0}),c);var D={};k(D,{default:()=>u});module.exports=C(D);var d=require("obsidian"),M={enableInDocument:!0,enableSidebar:!0,sortDescending:!0,debugMode:!0},u=class extends d.Plugin{constructor(){super(...arguments);this.pendingSort=null;this.styleEl=null}async onload(){await this.loadSettings(),console.log("[ChronoSort] Plugin loaded"),this.styleEl=document.createElement("style"),this.styleEl.id="chronosort-styles",this.styleEl.textContent="",document.head.appendChild(this.styleEl),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.settings.debugMode&&console.log("[ChronoSort] active-leaf-change event"),this.scheduleSortBacklinks()})),this.registerEvent(this.app.workspace.on("layout-change",()=>{this.settings.debugMode&&console.log("[ChronoSort] layout-change event"),this.scheduleSortBacklinks()})),this.app.workspace.onLayoutReady(()=>{this.settings.debugMode&&console.log("[ChronoSort] Layout ready"),this.scheduleSortBacklinks()}),this.addCommand({id:"sort-backlinks-now",name:"Sort backlinks chronologically now",callback:()=>{this.sortAllBacklinks()}}),this.addSettingTab(new m(this.app,this))}onunload(){console.log("[ChronoSort] Plugin unloaded"),this.pendingSort&&clearTimeout(this.pendingSort),this.styleEl&&this.styleEl.remove(),document.querySelectorAll("[data-chronosort-done]").forEach(t=>{t.removeAttribute("data-chronosort-done")})}async loadSettings(){this.settings=Object.assign({},M,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}scheduleSortBacklinks(){this.pendingSort&&clearTimeout(this.pendingSort),this.pendingSort=setTimeout(()=>{this.sortAllBacklinks(),this.pendingSort=null},500)}sortAllBacklinks(){this.settings.debugMode&&console.log("[ChronoSort] Running sortAllBacklinks"),this.settings.enableInDocument&&(this.sortInDocumentBacklinks(),this.sortDailyNotesEditorBacklinks()),this.settings.enableSidebar&&this.sortSidebarBacklinks()}sortInDocumentBacklinks(){let t=this.app.workspace.getActiveViewOfType(d.MarkdownView);if(!t){this.settings.debugMode&&console.log("[ChronoSort] No active markdown view");return}let e=[".backlink-pane .search-result-container",".backlink-pane",".embedded-backlinks .search-result-container",".embedded-backlinks"],o=null;for(let n of e)if(o=t.containerEl.querySelector(n),o){this.settings.debugMode&&console.log(`[ChronoSort] Found in-document backlinks with selector: ${n}`);break}if(!o){this.settings.debugMode&&console.log("[ChronoSort] No in-document backlinks container found");return}this.applySortOrder(o,"in-document")}sortSidebarBacklinks(){let t=['div[data-type="backlink"] .search-result-container','.workspace-leaf-content[data-type="backlink"] .search-result-container'],e=null;for(let o of t)if(e=document.querySelector(o),e){this.settings.debugMode&&console.log(`[ChronoSort] Found sidebar backlinks with selector: ${o}`);break}if(!e){this.settings.debugMode&&console.log("[ChronoSort] No sidebar backlinks pane found");return}this.applySortOrder(e,"sidebar")}sortDailyNotesEditorBacklinks(){let t=document.querySelectorAll(".daily-note-editor");if(t.length===0){this.settings.debugMode&&console.log("[ChronoSort] No Daily Notes Editor views found");return}this.settings.debugMode&&console.log(`[ChronoSort] Found ${t.length} Daily Notes Editor view(s)`),t.forEach((e,o)=>{let n=e.querySelectorAll(".embedded-backlinks .search-result-container");if(n.length===0){let s=e.querySelectorAll(".embedded-backlinks");this.settings.debugMode&&console.log(`[ChronoSort] Daily Notes Editor view ${o}: ${s.length} embedded-backlinks found (fallback)`),s.forEach((r,a)=>{this.applySortOrder(r,`daily-notes-editor-${o}-${a}`)})}else this.settings.debugMode&&console.log(`[ChronoSort] Daily Notes Editor view ${o}: ${n.length} backlinks containers found`),n.forEach((s,r)=>{this.applySortOrder(s,`daily-notes-editor-${o}-${r}`)})})}applySortOrder(t,e){if(t.hasAttribute("data-chronosort-done")){this.settings.debugMode&&console.log(`[ChronoSort] Container ${e} already sorted, skipping`);return}let o=t.querySelectorAll(":scope > .tree-item.search-result");if(o.length===0){this.settings.debugMode&&console.log(`[ChronoSort] No backlink items found in ${e}`);return}this.settings.debugMode&&console.log(`[ChronoSort] Sorting ${o.length} backlinks in ${e} (one-time)`);let n=[];o.forEach(s=>{let r=this.extractFilename(s),a=this.getTimestamp(r);n.push({element:s,timestamp:a,filename:r})}),n.sort((s,r)=>{let a=s.timestamp-r.timestamp;return this.settings.sortDescending?-a:a}),this.settings.debugMode&&console.log("[ChronoSort] Sorted order:",n.slice(0,10).map(s=>`${s.filename} (${new Date(s.timestamp).toISOString().split("T")[0]})`)),n.forEach(s=>{t.appendChild(s.element)}),t.setAttribute("data-chronosort-done","true"),this.settings.debugMode&&console.log(`[ChronoSort] Sorted ${n.length} items in ${e} (will not re-sort)`)}extractFilename(t){var s,r,a;let e=t.querySelector(":scope > .tree-item-self .tree-item-inner");if(e){let l=((s=e.textContent)==null?void 0:s.trim())||"";if(this.settings.debugMode&&l&&console.log(`[ChronoSort] Extracted from tree-item-self: "${l}"`),l)return l}let o=t.querySelector(".search-result-file-title");if(o){let l=((r=o.textContent)==null?void 0:r.trim())||"";if(this.settings.debugMode&&l&&console.log(`[ChronoSort] Extracted from file-title: "${l}"`),l)return l}let n=t.querySelectorAll(".tree-item-inner");for(let l of Array.from(n)){if(l.closest(".search-result-file-matches"))continue;let g=((a=l.textContent)==null?void 0:a.trim())||"";if(g)return this.settings.debugMode&&console.log(`[ChronoSort] Extracted from filtered tree-item-inner: "${g}"`),g}return this.settings.debugMode&&console.log("[ChronoSort] Could not extract filename from item"),""}getTimestamp(t){let e=this.parseRoamDate(t);if(e!==null)return this.settings.debugMode&&console.log(`[ChronoSort] Parsed Roam date for "${t}": ${new Date(e).toISOString()}`),e;let o=this.parseISODate(t);if(o!==null)return this.settings.debugMode&&console.log(`[ChronoSort] Parsed ISO date for "${t}": ${new Date(o).toISOString()}`),o;let n=this.app.vault.getAbstractFileByPath(t+".md")||this.app.vault.getAbstractFileByPath(t);if(this.settings.debugMode&&console.log(`[ChronoSort] File lookup for "${t}":`,{foundFile:!!n,isFile:n instanceof d.TFile,filePath:n==null?void 0:n.path}),n&&n instanceof d.TFile){let a=this.getFrontmatterDate(n);return a!==null?(this.settings.debugMode&&console.log(`[ChronoSort] Using frontmatter 'edited' for "${t}": ${new Date(a).toISOString()}`),a):(this.settings.debugMode&&console.log(`[ChronoSort] Using mtime for "${t}": ${new Date(n.stat.mtime).toISOString()}`),n.stat.mtime)}let s=`Daily Notes/${t}.md`,r=this.app.vault.getAbstractFileByPath(s);return r&&r instanceof d.TFile?(this.settings.debugMode&&console.log(`[ChronoSort] Using Daily Notes mtime for "${t}": ${new Date(r.stat.mtime).toISOString()}`),r.stat.mtime):(this.settings.debugMode&&console.log(`[ChronoSort] No timestamp found for "${t}", returning 0`),0)}getFrontmatterDate(t){var g,b;let e=this.app.metadataCache.getFileCache(t);if(this.settings.debugMode&&console.log(`[ChronoSort] getFrontmatterDate for "${t.path}":`,{hasCache:!!e,hasFrontmatter:!!(e!=null&&e.frontmatter),frontmatterKeys:e!=null&&e.frontmatter?Object.keys(e.frontmatter):[],editedValue:(g=e==null?void 0:e.frontmatter)==null?void 0:g.edited,createdValue:(b=e==null?void 0:e.frontmatter)==null?void 0:b.created}),!(e!=null&&e.frontmatter))return null;let o=e.frontmatter.edited||e.frontmatter.created;if(!o)return null;let n=String(o).match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!n)return this.settings.debugMode&&console.log(`[ChronoSort] Date format mismatch for "${t.path}": "${o}"`),null;let[,s,r,a]=n;return new Date(parseInt(s),parseInt(r)-1,parseInt(a)).getTime()}parseRoamDate(t){let e={January:0,February:1,March:2,April:3,May:4,June:5,July:6,August:7,September:8,October:9,November:10,December:11},o=t.match(/^(\w+)\s+(\d+)(?:st|nd|rd|th),\s+(\d{4})$/);if(!o){let g=t.match(/\[\[(January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d+)(?:st|nd|rd|th),\s+(\d{4})\]\]/);g&&(o=g)}if(!o)return this.settings.debugMode&&t.match(/january|february|march|april|may|june|july|august|september|october|november|december/i)&&console.log(`[ChronoSort] Roam date regex FAILED for "${t}" (looks like a date but didn't match)`),null;let[,n,s,r]=o,a=e[n];if(a===void 0)return null;let l=new Date(parseInt(r),a,parseInt(s));return l.getFullYear()!==parseInt(r)||l.getMonth()!==a||l.getDate()!==parseInt(s)?null:l.getTime()}parseISODate(t){let e=t.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!e)return null;let[,o,n,s]=e,r=new Date(parseInt(o),parseInt(n)-1,parseInt(s));return r.getFullYear()!==parseInt(o)||r.getMonth()!==parseInt(n)-1||r.getDate()!==parseInt(s)?null:r.getTime()}},m=class extends d.PluginSettingTab{constructor(i,t){super(i,t),this.plugin=t}display(){let{containerEl:i}=this;i.empty(),i.createEl("h2",{text:"Backlinks Chronological Sort"}),new d.Setting(i).setName("Enable for in-document backlinks").setDesc("Sort backlinks shown at the bottom of notes").addToggle(t=>t.setValue(this.plugin.settings.enableInDocument).onChange(async e=>{this.plugin.settings.enableInDocument=e,await this.plugin.saveSettings()})),new d.Setting(i).setName("Enable for sidebar backlinks").setDesc("Sort backlinks shown in the sidebar pane").addToggle(t=>t.setValue(this.plugin.settings.enableSidebar).onChange(async e=>{this.plugin.settings.enableSidebar=e,await this.plugin.saveSettings()})),new d.Setting(i).setName("Sort descending (newest first)").setDesc("When enabled, most recent dates appear at the top").addToggle(t=>t.setValue(this.plugin.settings.sortDescending).onChange(async e=>{this.plugin.settings.sortDescending=e,await this.plugin.saveSettings()})),new d.Setting(i).setName("Debug mode").setDesc("Log sorting information to console").addToggle(t=>t.setValue(this.plugin.settings.debugMode).onChange(async e=>{this.plugin.settings.debugMode=e,await this.plugin.saveSettings()}))}};
