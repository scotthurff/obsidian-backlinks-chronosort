var h=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var k=(u,a)=>{for(var t in a)h(u,t,{get:a[t],enumerable:!0})},v=(u,a,t,e)=>{if(a&&typeof a=="object"||typeof a=="function")for(let n of f(a))!S.call(u,n)&&n!==t&&h(u,n,{get:()=>a[n],enumerable:!(e=p(a,n))||e.enumerable});return u};var y=u=>v(h({},"__esModule",{value:!0}),u);var C={};k(C,{default:()=>d});module.exports=y(C);var c=require("obsidian"),D={enableInDocument:!0,enableSidebar:!0,sortDescending:!0,debugMode:!0},d=class extends c.Plugin{constructor(){super(...arguments);this.observers=[];this.debounceTimers=new Map;this.isSorting=!1}async onload(){await this.loadSettings(),console.log("[ChronoSort] Plugin loaded"),this.registerEvent(this.app.workspace.on("layout-change",()=>{this.setupObservers()})),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.setupObservers()})),this.app.workspace.onLayoutReady(()=>{this.setupObservers()}),this.addSettingTab(new m(this.app,this))}onunload(){console.log("[ChronoSort] Plugin unloaded"),this.disconnectObservers()}async loadSettings(){this.settings=Object.assign({},D,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}disconnectObservers(){this.observers.forEach(t=>t.disconnect()),this.observers=[],this.debounceTimers.forEach(t=>clearTimeout(t)),this.debounceTimers.clear()}setupObservers(){this.disconnectObservers(),this.settings.enableInDocument&&this.observeInDocumentBacklinks(),this.settings.enableSidebar&&this.observeSidebarBacklinks()}observeInDocumentBacklinks(){let t=this.app.workspace.getActiveViewOfType(c.MarkdownView);if(!t)return;let e=t.containerEl.querySelector(".backlink-pane");if(!e){this.settings.debugMode&&console.log("[ChronoSort] No in-document backlinks container found");return}this.settings.debugMode&&console.log("[ChronoSort] Found in-document backlinks container"),this.createObserver(e,"in-document")}observeSidebarBacklinks(){let t=document.querySelector('div[data-type="backlink"] .search-result-container');if(!t){this.settings.debugMode&&console.log("[ChronoSort] No sidebar backlinks pane found");return}this.settings.debugMode&&console.log("[ChronoSort] Found sidebar backlinks pane"),this.createObserver(t,"sidebar")}createObserver(t,e){let n=new MutationObserver(s=>{if(this.isSorting)return;let l=this.debounceTimers.get(e);l&&clearTimeout(l);let r=setTimeout(()=>{this.sortBacklinks(t,e)},150);this.debounceTimers.set(e,r)});n.observe(t,{childList:!0,subtree:!0}),this.observers.push(n),setTimeout(()=>this.sortBacklinks(t,e),200)}sortBacklinks(t,e){var r;let n=t.querySelectorAll(".tree-item.search-result");if(n.length===0){this.settings.debugMode&&console.log(`[ChronoSort] No backlink items found in ${e}`);return}this.settings.debugMode&&console.log(`[ChronoSort] Sorting ${n.length} backlinks in ${e}`);let s=[];n.forEach(i=>{let o=this.extractFilename(i),g=this.getTimestamp(o);s.push({element:i,timestamp:g,filename:o})}),s.sort((i,o)=>{let g=i.timestamp-o.timestamp;return this.settings.sortDescending?-g:g}),this.settings.debugMode&&console.log("[ChronoSort] Sorted order:",s.slice(0,10).map(i=>`${i.filename} (${new Date(i.timestamp).toISOString().split("T")[0]})`));let l=(r=n[0])==null?void 0:r.parentElement;l&&(this.isSorting=!0,s.forEach(i=>{l.appendChild(i.element)}),setTimeout(()=>{this.isSorting=!1},50),this.settings.debugMode&&console.log(`[ChronoSort] Re-sorted ${s.length} items`))}extractFilename(t){var l,r,i;let e=t.querySelector(":scope > .tree-item-self .tree-item-inner");if(e){let o=((l=e.textContent)==null?void 0:l.trim())||"";if(this.settings.debugMode&&o&&console.log(`[ChronoSort] Extracted from tree-item-self: "${o}"`),o)return o}let n=t.querySelector(".search-result-file-title");if(n){let o=((r=n.textContent)==null?void 0:r.trim())||"";if(this.settings.debugMode&&o&&console.log(`[ChronoSort] Extracted from file-title: "${o}"`),o)return o}let s=t.querySelectorAll(".tree-item-inner");for(let o of Array.from(s)){if(o.closest(".search-result-file-matches"))continue;let g=((i=o.textContent)==null?void 0:i.trim())||"";if(g)return this.settings.debugMode&&console.log(`[ChronoSort] Extracted from filtered tree-item-inner: "${g}"`),g}return this.settings.debugMode&&console.log("[ChronoSort] Could not extract filename from item"),""}getTimestamp(t){let e=this.parseRoamDate(t);if(e!==null)return this.settings.debugMode&&console.log(`[ChronoSort] Parsed Roam date for "${t}": ${new Date(e).toISOString()}`),e;let n=this.parseISODate(t);if(n!==null)return this.settings.debugMode&&console.log(`[ChronoSort] Parsed ISO date for "${t}": ${new Date(n).toISOString()}`),n;let s=this.app.vault.getAbstractFileByPath(t+".md")||this.app.vault.getAbstractFileByPath(t);if(this.settings.debugMode&&console.log(`[ChronoSort] File lookup for "${t}":`,{foundFile:!!s,isFile:s instanceof c.TFile,filePath:s==null?void 0:s.path}),s&&s instanceof c.TFile){let i=this.getFrontmatterDate(s);return i!==null?(this.settings.debugMode&&console.log(`[ChronoSort] Using frontmatter 'edited' for "${t}": ${new Date(i).toISOString()}`),i):(this.settings.debugMode&&console.log(`[ChronoSort] Using mtime for "${t}": ${new Date(s.stat.mtime).toISOString()}`),s.stat.mtime)}let l=`Daily Notes/${t}.md`,r=this.app.vault.getAbstractFileByPath(l);return r&&r instanceof c.TFile?(this.settings.debugMode&&console.log(`[ChronoSort] Using Daily Notes mtime for "${t}": ${new Date(r.stat.mtime).toISOString()}`),r.stat.mtime):(this.settings.debugMode&&console.log(`[ChronoSort] No timestamp found for "${t}", returning 0`),0)}getFrontmatterDate(t){var g,b;let e=this.app.metadataCache.getFileCache(t);if(this.settings.debugMode&&console.log(`[ChronoSort] getFrontmatterDate for "${t.path}":`,{hasCache:!!e,hasFrontmatter:!!(e!=null&&e.frontmatter),frontmatterKeys:e!=null&&e.frontmatter?Object.keys(e.frontmatter):[],editedValue:(g=e==null?void 0:e.frontmatter)==null?void 0:g.edited,createdValue:(b=e==null?void 0:e.frontmatter)==null?void 0:b.created}),!(e!=null&&e.frontmatter))return null;let n=e.frontmatter.edited||e.frontmatter.created;if(!n)return null;let s=String(n).match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!s)return this.settings.debugMode&&console.log(`[ChronoSort] Date format mismatch for "${t.path}": "${n}"`),null;let[,l,r,i]=s;return new Date(parseInt(l),parseInt(r)-1,parseInt(i)).getTime()}parseRoamDate(t){let e={January:0,February:1,March:2,April:3,May:4,June:5,July:6,August:7,September:8,October:9,November:10,December:11},n=t.match(/^(\w+)\s+(\d+)(?:st|nd|rd|th),\s+(\d{4})$/);if(!n){let g=t.match(/\[\[(January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d+)(?:st|nd|rd|th),\s+(\d{4})\]\]/);g&&(n=g)}if(!n)return this.settings.debugMode&&t.match(/january|february|march|april|may|june|july|august|september|october|november|december/i)&&console.log(`[ChronoSort] Roam date regex FAILED for "${t}" (looks like a date but didn't match)`),null;let[,s,l,r]=n,i=e[s];if(i===void 0)return null;let o=new Date(parseInt(r),i,parseInt(l));return o.getFullYear()!==parseInt(r)||o.getMonth()!==i||o.getDate()!==parseInt(l)?null:o.getTime()}parseISODate(t){let e=t.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!e)return null;let[,n,s,l]=e,r=new Date(parseInt(n),parseInt(s)-1,parseInt(l));return r.getFullYear()!==parseInt(n)||r.getMonth()!==parseInt(s)-1||r.getDate()!==parseInt(l)?null:r.getTime()}},m=class extends c.PluginSettingTab{constructor(a,t){super(a,t),this.plugin=t}display(){let{containerEl:a}=this;a.empty(),a.createEl("h2",{text:"Backlinks Chronological Sort"}),new c.Setting(a).setName("Enable for in-document backlinks").setDesc("Sort backlinks shown at the bottom of notes").addToggle(t=>t.setValue(this.plugin.settings.enableInDocument).onChange(async e=>{this.plugin.settings.enableInDocument=e,await this.plugin.saveSettings()})),new c.Setting(a).setName("Enable for sidebar backlinks").setDesc("Sort backlinks shown in the sidebar pane").addToggle(t=>t.setValue(this.plugin.settings.enableSidebar).onChange(async e=>{this.plugin.settings.enableSidebar=e,await this.plugin.saveSettings()})),new c.Setting(a).setName("Sort descending (newest first)").setDesc("When enabled, most recent dates appear at the top").addToggle(t=>t.setValue(this.plugin.settings.sortDescending).onChange(async e=>{this.plugin.settings.sortDescending=e,await this.plugin.saveSettings()})),new c.Setting(a).setName("Debug mode").setDesc("Log sorting information to console").addToggle(t=>t.setValue(this.plugin.settings.debugMode).onChange(async e=>{this.plugin.settings.debugMode=e,await this.plugin.saveSettings()}))}};
